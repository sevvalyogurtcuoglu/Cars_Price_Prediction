# -*- coding: utf-8 -*-
"""
Created on Thu Jul 23 01:48:32 2020

@author: TOSHIBA
"""

from flask import Flask, abort, jsonify, request, render_template
from sklearn.externals import joblib
import numpy as np
import json

gbr = joblib.load('model.pkl')

app = Flask(__name__)

@app.route('/')
def home():
    return render_template('index.html')



def input_to_one_hot(data):
    enc_input = np.zeros(361) #132 339
    enc_input[0] = data['Kilometre']
    enc_input[1] = data['Yil']
    
    # get the array of marks categories
    marks = ['FIAT',
'FORD',
'OPEL',
'RENAULT',
'DACIA',
'PEUGEOT',
'MERCEDES',
'NİSSAN',
'VOLVO',
'VOLKSWAGEN',
'HYUNDAI',
'JEEP',
'ALFA ROMEO',
'BMW',
'HONDA',
'CITRÖEN',
'TOYOTA',
'SEAT',
'KIA',
'SKODA',
'MİNİ',
'SUBARU',
'SUZUKİ',
'AUDI',
'TATA']
    cols = ['Kilometre',
'Yil',
'Marka_ALFA ROMEO',
'Marka_AUDI',
'Marka_BMW',
'Marka_CITRÖEN',
'Marka_DACIA',
'Marka_FIAT',
'Marka_FORD',
'Marka_HONDA',
'Marka_HYUNDAI',
'Marka_JEEP',
'Marka_KIA',
'Marka_MERCEDES',
'Marka_MİNİ',
'Marka_NİSSAN',
'Marka_OPEL',
'Marka_PEUGEOT',
'Marka_RENAULT',
'Marka_SEAT',
'Marka_SKODA',
'Marka_SUBARU',
'Marka_SUZUKİ',
'Marka_TATA',
'Marka_TOYOTA',
'Marka_VOLKSWAGEN',
'Marka_VOLVO',
'Vites_Manuel',
'Vites_Otomatik',
'Vites_Yarı Otomatik',
'Yakit_Benzin',
'Yakit_Dizel',
'Yakit_Elektrik',
'Yakit_LPG',
'Seri_Civic',
'Seri_Astra',
'Seri_3 Serisi',
'Seri_Passat',
'Seri_C Serisi',
'Seri_Focus',
'Seri_5 Serisi',
'Seri_Clio',
'Seri_E Serisi',
'Seri_Corsa',
'Seri_Polo',
'Seri_Golf',
'Seri_Corolla',
'Seri_Megane',
'Seri_Jetta',
'Seri_i20',
'Seri_Fluence',
'Seri_A3',
'Seri_Egea',
'Seri_Fiesta',
'Seri_Symbol',
'Seri_Insignia',
'Seri_Leon',
'Seri_A4',
'Seri_1 Serisi',
'Seri_Auris',
'Seri_Accent Blue',
'Seri_Octavia',
'Seri_A6',
'Seri_Vectra',
'Seri_206',
'Seri_Punto',
'Seri_VW CC',
'Seri_Linea',
'Seri_Getz',
'Seri_Jazz',
'Seri_Micra',
'Seri_Şahin',
'Seri_307',
'Seri_Accent',
'Seri_Ibiza',
'Seri_301',
'Seri_Sandero',
'Seri_i30',
'Seri_Elantra',
'Seri_Yaris',
'Seri_Doğan',
'Seri_4 Serisi',
'Seri_308',
'Seri_A Serisi',
'Seri_CLA',
'Seri_Cruze',
'Seri_Accent Era',
'Seri_Mondeo',
'Seri_S Serisi',
'Seri_Palio',
'Seri_207',
'Seri_C4',
'Seri_C-Elysée',
'Seri_Superb',
'Seri_Albea',
'Seri_Scirocco',
'Seri_R 9',
'Seri_Bora',
'Seri_Cooper',
'Seri_Aveo',
'Seri_208',
'Seri_Panamera',
'Seri_S60',
'Seri_Fabia',
'Seri_A5',
'Seri_Cerato',
'Seri_Accord',
'Seri_B Serisi',
'Seri_Ceed',
'Seri_Rio',
'Seri_C3',
'Seri_508',
'Seri_CLS',
'Seri_City',
'Seri_Avensis',
'Seri_CLK',
'Seri_Laguna',
'Seri_i10',
'Seri_R 12',
'Seri_Uno',
'Seri_200',
'Seri_300',
'Seri_Tipo',
'Seri_Model S',
'Seri_R 19',
'Seri_Scenic',
'Seri_Swift',
'Seri_3',
'Seri_300 C',
'Seri_106',
'Seri_i Serisi',
'Seri_Cooper S',
'Seri_Marea',
'Seri_Rapid',
'Seri_V40',
'Seri_Tempra',
'Seri_7 Serisi',
'Seri_Lancer',
'Seri_S40',
'Seri_Fusion',
'Seri_Lacetti',
'Seri_Kalos',
'Seri_Beetle',
'Seri_306',
'Seri_Sonata',
'Seri_Kartal',
'Seri_C5',
'Seri_323',
'Seri_Passat Variant',
'Seri_Meriva',
'Seri_Talisman',
'Seri_Panda',
'Seri_2 Serisi',
'Seri_Fortwo',
'Seri_Toledo',
'Seri_Giulietta',
'Seri_Logan',
'Seri_Picanto',
'Seri_S90',
'Seri_ZOE',
'Seri_Twizy',
'Seri_190',
'Seri_Latitude',
'Seri_Carisma',
'Seri_Camaro',
'Seri_406',
'Seri_GranTurismo',
'Seri_S80',
'Seri_A8',
'Seri_XF',
'Seri_Lodgy',
'Seri_Arteon',
'Seri_Note',
'Seri_Carina',
'Seri_Cordoba',
'Seri_Touran',
'Seri_Brava',
'Seri_C-Max',
'Seri_Vega',
'Seri_Siena',
'Seri_6 Serisi',
'Seri_Colt',
'Seri_206 +',
'Seri_Escort',
'Seri_XJ',
'Seri_407',
'Seri_Z Serisi',
'Seri_Bravo',
'Seri_Twingo',
'Seri_500 Ailesi',
'Seri_Serçe',
'Seri_XE',
'Seri_i20 Troy',
'Seri_RCZ',
'Seri_Sirion',
'Seri_A1',
'Seri_Modus',
'Seri_Atos',
'Seri_B-Max',
'Seri_Felicia',
'Seri_TT',
'Seri_Pulsar',
'Seri_One',
'Seri_Samara',
'Seri_Coupe',
'Seri_Forman',
'Seri_Fluence Z.E.',
'Seri_Splash',
'Seri_Model X',
'Seri_Quattroporte',
'Seri_Almera',
'Seri_300 M',
'Seri_107',
'Seri_156',
'Seri_M Serisi',
'Seri_C4 Grand Picasso',
'Seri_Safrane',
'Seri_Camry',
'Seri_Omega',
'Seri_Shuma',
'Seri_Genesis',
'Seri_A7',
'Seri_626',
'Seri_416',
'Seri_147',
'Seri_SLK',
'Seri_230',
'Seri_Solenza',
'Seri_CLC',
'Seri_Corona',
'Seri_R 21',
'Seri_Emgrand',
'Seri_Impreza',
'Seri_Granada',
'Seri_C2',
'Seri_718',
'Seri_PT Cruiser',
'Seri_Stratus',
'Seri_415',
'Seri_S2000',
'Seri_9-3',
'Seri_Spark',
'Seri_R 11',
'Seri_EOS',
'Seri_Mustang',
'Seri_Ka',
'Seri_DeVille',
'Seri_DS 3',
'Seri_Boxster',
'Seri_Saxo',
'Seri_C30',
'Seri_Idea',
'Seri_Shuttle',
'Seri_Fleetwood',
'Seri_Rezzo',
'Seri_Murat',
'Seri_Vantage',
'Seri_159',
'Seri_C4 Picasso',
'Seri_S-Type',
'Seri_220',
'Seri_Xedos',
'Seri_214',
'Seri_315',
'Seri_Roadster',
'Seri_Corvette',
'Seri_Thema',
'Seri_Alto',
'Seri_Matiz',
'Seri_DS 5',
'Seri_XJR',
'Seri_Zafira',
'Seri_Opirus',
'Seri_MPV',
'Seri_V60',
'Seri_Y ( Ypsilon )',
'Seri_DB9',
'Seri_250',
'Seri_Monte Carlo',
'Seri_420',
'Seri_Galant',
'Seri_80 Serisi',
'Seri_Sebring',
'Seri_iX20',
'Seri_Lantis',
'Seri_Cooper Clubman',
'Seri_Daimler',
'Seri_R Serisi',
'Seri_SX4',
'Seri_6',
'Seri_Primera',
'Seri_Stilo',
'Seri_2',
'Seri_25',
'Seri_205',
'Seri_Ascona',
'Seri_Roomster',
'Seri_Indigo',
'Seri_Sephia',
'Seri_Sovereign',
'Seri_Urban Cruiser',
'Seri_Verso',
'Seri_500',
'Seri_Attrage',
'Seri_Multipla',
'Seri_Echo',
'Seri_XK8',
'Seri_Cayman',
'Seri_100 Serisi',
'Seri_Leganza',
'Seri_Space Star',
'Seri_VAZ',
'Seri_Capital',
'Seri_Vista',
'Seri_Taunus',
'Seri_I30',
'Seri_F-Type',
'Seri_Pro Ceed',
'Seri_Matrix',
'Seri_i20 Active',
'Seri_CL',
'Seri_Baleno',
'Seri_Riviera',
'Seri_X-Type',
'Seri_911',
'Seri_C1',
'Seri_Ghibli',
'Seri_Galaxy',
'Seri_Legacy',
'Seri_Lancer Evolution',
'Seri_MX',
'Seri_928',
'Seri_Citigo',
'Seri_Grandeur',
'Seri_Q50',
'Seri_430',
'Seri_Starlet',
'Seri_V40 Cross Country'

]

    redefinded_user_input = 'Marka_'+data['Marka']
    mark_column_index = cols.index(redefinded_user_input)
    enc_input[mark_column_index] = 1

    fuel_type = ['Dizel', 'Benzin', 'Elektrik', 'LPG']
    redefinded_user_input = 'Yakit_'+data['Yakit']
    fuelType_column_index = cols.index(redefinded_user_input)
    enc_input[fuelType_column_index] = 1

    vites =['Manuel', 'Yarı Otomatik', 'Otomatik'] 
    redefinded_user_input = 'Vites_'+data['Vites']
    vites_column_index =cols.index(redefinded_user_input)
    enc_input[vites_column_index] = 1
    
    seri = ['Civic',
'Astra',
'3 Serisi',
'Passat',
'C Serisi',
'Focus',
'5 Serisi',
'Clio',
'E Serisi',
'Corsa',
'Polo',
'Golf',
'Corolla',
'Megane',
'Jetta',
'i20',
'Fluence',
'A3',
'Egea',
'Fiesta',
'Symbol',
'Insignia',
'Leon',
'A4',
'1 Serisi',
'Auris',
'Accent Blue',
'Octavia',
'A6',
'Vectra',
'206',
'Punto',
'VW CC',
'Linea',
'Getz',
'Jazz',
'Micra',
'Şahin',
'307',
'Accent',
'Ibiza',
'301',
'Sandero',
'i30',
'Elantra',
'Yaris',
'Doğan',
'4 Serisi',
'308',
'A Serisi',
'CLA',
'Cruze',
'Accent Era',
'Mondeo',
'S Serisi',
'Palio',
'207',
'C4',
'C-Elysée',
'Superb',
'Albea',
'Scirocco',
'R 9',
'Bora',
'Cooper',
'Aveo',
'208',
'Panamera',
'S60',
'Fabia',
'A5',
'Cerato',
'Accord',
'B Serisi',
'Ceed',
'Rio',
'C3',
'508',
'CLS',
'City',
'Avensis',
'CLK',
'Laguna',
'i10',
'R 12',
'Uno',
'200',
'300',
'Tipo',
'Model S',
'R 19',
'Scenic',
'Swift',
'3',
'300 C',
'106',
'i Serisi',
'Cooper S',
'Marea',
'Rapid',
'V40',
'Tempra',
'7 Serisi',
'Lancer',
'S40',
'Fusion',
'Lacetti',
'Kalos',
'Beetle',
'306',
'Sonata',
'Kartal',
'C5',
'323',
'Passat Variant',
'Meriva',
'Talisman',
'Panda',
'2 Serisi',
'Fortwo',
'Toledo',
'Giulietta',
'Logan',
'Picanto',
'S90',
'ZOE',
'Twizy',
'190',
'Latitude',
'Carisma',
'Camaro',
'406',
'GranTurismo',
'S80',
'A8',
'XF',
'Lodgy',
'Arteon',
'Note',
'Carina',
'Cordoba',
'Touran',
'Brava',
'C-Max',
'Vega',
'Siena',
'6 Serisi',
'Colt',
'206 +',
'Escort',
'XJ',
'407',
'Z Serisi',
'Bravo',
'Twingo',
'500 Ailesi',
'Serçe',
'XE',
'i20 Troy',
'RCZ',
'Sirion',
'A1',
'Modus',
'Atos',
'B-Max',
'Felicia',
'TT',
'Pulsar',
'One',
'Samara',
'Coupe',
'Forman',
'Fluence Z.E.',
'Splash',
'Model X',
'Quattroporte',
'Almera',
'300 M',
'107',
'156',
'M Serisi',
'C4 Grand Picasso',
'Safrane',
'Camry',
'Omega',
'Shuma',
'Genesis',
'A7',
'626',
'416',
'147',
'SLK',
'230',
'Solenza',
'CLC',
'Corona',
'R 21',
'Emgrand',
'Impreza',
'Granada',
'C2',
'718',
'PT Cruiser',
'Stratus',
'415',
'S2000',
'9-3',
'Spark',
'R 11',
'EOS',
'Mustang',
'Ka',
'DeVille',
'DS 3',
'Boxster',
'Saxo',
'C30',
'Idea',
'Shuttle',
'Fleetwood',
'Rezzo',
'Murat',
'Vantage',
'159',
'C4 Picasso',
'S-Type',
'220',
'Xedos',
'214',
'315',
'Roadster',
'Corvette',
'Thema',
'Alto',
'Matiz',
'DS 5',
'XJR',
'Zafira',
'Opirus',
'MPV',
'V60',
'Y ( Ypsilon )',
'DB9',
'250',
'Monte Carlo',
'420',
'Galant',
'80 Serisi',
'Sebring',
'iX20',
'Lantis',
'Cooper Clubman',
'Daimler',
'R Serisi',
'SX4',
'6',
'Primera',
'Stilo',
'2',
'25',
'205',
'Ascona',
'Roomster',
'Indigo',
'Sephia',
'Sovereign',
'Urban Cruiser',
'Verso',
'500',
'Attrage',
'Multipla',
'Echo',
'XK8',
'Cayman',
'100 Serisi',
'Leganza',
'Space Star',
'VAZ',
'Capital',
'Vista',
'Taunus',
'I30',
'F-Type',
'Pro Ceed',
'Matrix',
'i20 Active',
'CL',
'Baleno',
'Riviera',
'X-Type',
'911',
'C1',
'Ghibli',
'Galaxy',
'Legacy',
'Lancer Evolution',
'MX',
'928',
'Citigo',
'Grandeur',
'Q50',
'430',
'Starlet',
'V40 Cross Country']
    redefinded_user_input = 'Seri_'+data['Seri']
    seri_column_index = cols.index(redefinded_user_input)
    enc_input[seri_column_index] = 1
    return enc_input

@app.route('/api',methods=['POST'])
def get_delay():
    result=request.form
    Yil = result['Yil']
    Kilometre = result['Kilometre']
    Marka = result['Marka']
    Vites = result['Vites']
    Yakit = result['Yakit']
    seri = result['Seri']

    user_input = {'Yil':Yil, 'Kilometre':Kilometre, 'Vites':Vites, 'Yakit':Yakit, 'Marka':Marka, 'Seri':seri}
    
    print(user_input)
    a = input_to_one_hot(user_input)
    price_pred = gbr.predict([a])[0]
    price_pred = round(price_pred, 2)
    return render_template('api.html',prediction_text=price_pred)

if __name__ == '__main__':
    app.run()



